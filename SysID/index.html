<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
  </head>
  <body>
    <div>
      <p>Output:</p>
      <textarea id="output" style="width: 100%; height: 500px;" rows="10" disabled></textarea>
    </div>

    <div>
      <form id="customForm">
        <input type="checkbox" id="tf_checkbox" name="customCheckbox">
        <label for="transfer function">Transfer function</label><br><br>

        <input type="checkbox" id="ss_checkbox" name="customCheckbox">
        <label for="state space">State Space</label><br><br>
      </form>
    </div>

    <!-- FOR TRANSFER FUNCTION -->
    <div id="tf_form" style="display:none;">
      <!-- <label for="No. of Poles">Poles:</label>                  
      <input type="number" id="Poles" name="Poles">

      <label for="No. of Zeros">Zeros:</label>
      <input type="number" id="Zeros" name="Zeros"> -->

      <label for="Input">Input Name:</label>
      <input type="text" id="input_name" name="input_name"><br><br>

      <label for="Input">Input Field:</label>
      <input type="text" id="input_field" name="input_field"><br><br>

      <label for="Output">Output Field:</label>
      <input type="text" id="output_name" name="output_name"><br><br>

      <label for="Output">Output:</label>
      <input type="text" id="output_field" name="output_field"><br><br>

      <label for="start time">Start time (in microseconds):</label>
      <input type="number" id="starttime" name="starttime"><br><br>

      <label for="end time">End time (in microseconds):</label>
      <input type="number" id="endtime" name="endtime"><br><br>

      <label for="customNumerator">Numerator:</label>
      <input type="text" id="customNumerator" name="customNumerator"><br><br>

      <label for="customDenominator">Denominator:</label>
      <input type="text" id="customDenominator" name="customDenominator"><br><br>

      <label for="tf_params">Symbolic params:</label>
      <input type="text" id="tf_params" name="tf_params"><br><br>

      <label for="file">Log File:</label>
      <input type="file" id="fileInput" name="file">
      <button id="parseButton" type="button">Submit</button>
    </div>

    <!-- FOR STATE SPACE MODEL -->
    <div id="ss_form" style="display:none;">
      <label for="No. of Inputs">Inputs:</label>                  
      <input type="number" id="num_Inputs" name="Inputs">

      <label for="No. of Outputs">Outputs:</label>
      <input type="number" id="num_Outputs" name="Outputs">

      <button id="createFieldsButton" type="button">Submit</button>
      <br><br>

      <div id="inputFieldsContainer"></div>
      <div id="outputFieldsContainer"></div>
      
      <label for="A">Matrix: A:</label>
      <input type="text" id="A" name="MatrixA"><br><br>

      <label for="B">Matrix: B:</label>
      <input type="text" id="B" name="MatrixB"><br><br>

      <label for="file">Log File:</label>
      <input type="file" id="fileInput" name="file">
      <button id="parseButton" type="button">Submit</button>
    </div>

    <script type="text/javascript">
      async function main() {
        const output = document.getElementById("output");
        output.value = '';
        function addToOutput(message) {
          output.value += message + "\n";
        }

        function createInputFields(containerId, labelPrefix, inputNamePrefix, numFields) {
          const container = document.getElementById(containerId);
          container.innerHTML = '';  // Clear any existing fields

          for (let i = 0; i < numFields; i++) {
            const label = document.createElement('label');
            label.textContent = `${labelPrefix} ${i + 1}:`;
            container.appendChild(label);

            const inputName = document.createElement('input');
            inputName.type = 'text';
            inputName.name = `${inputNamePrefix}_name_${i + 1}`;
            inputName.id = `${inputNamePrefix}_name_${i + 1}`;
            container.appendChild(inputName);

            const inputField = document.createElement('input');
            inputField.type = 'text';
            inputField.name = `${inputNamePrefix}_field_${i + 1}`;
            inputField.id = `${inputNamePrefix}_field_${i + 1}`;
            container.appendChild(inputField);

            container.appendChild(document.createElement('br'));
          }
        }

        document.getElementById("tf_checkbox").addEventListener("change", function () {
        if (this.checked) {
          document.getElementById("ss_checkbox").checked = false;
          document.getElementById("tf_form").style.display = "block";
          document.getElementById("ss_form").style.display = "none";
        } else {
          document.getElementById("tf_form").style.display = "none";
        }
        });

        document.getElementById("ss_checkbox").addEventListener("change", function () {
        if (this.checked) {
          document.getElementById("tf_checkbox").checked = false;
          document.getElementById("ss_form").style.display = "block";
          document.getElementById("tf_form").style.display = "none";

          document.getElementById('createFieldsButton').addEventListener('click', function () {
          
          const numInputs = parseInt(document.getElementById('num_Inputs').value, 10);
          const numOutputs = parseInt(document.getElementById('num_Outputs').value, 10);

          if (isNaN(numInputs) || isNaN(numOutputs) || numInputs <= 0 || numOutputs <= 0) {
            alert('Please enter valid numbers for inputs and outputs.');
            return;
          }

          createInputFields('inputFieldsContainer', 'Input', 'input', numInputs);
          createInputFields('outputFieldsContainer', 'Output', 'output', numOutputs);
        });
        } else {
          document.getElementById("ss_form").style.display = "none";
        }
        });


        addToOutput("Initializing Pyodide...");
        let pyodide = await loadPyodide();

        addToOutput("Loading micropip package...");
        await pyodide.loadPackage("micropip");
        const micropip = pyodide.pyimport("micropip");

        addToOutput("Installing matplotlib package...");
        await micropip.install("matplotlib");

        addToOutput("Installing control package...");
        await micropip.install("control", keep_going=true, deps=false);

        const packageUrl = "../modules/pyAircraftIden/gi.whl";
        
        addToOutput(`Installing pyAircraftIden package from ${packageUrl}...`);
        try {
          await micropip.install(packageUrl, { keep_going: true, upgrade: true });
          addToOutput("pyAircraftIden package installed successfully.");
        } catch (error) {
          addToOutput(`Failed to install pyAircraftIden package: ${error}`);
        }

        try {
          const import_done = import('../modules/JsDataflashParser/parser.js').then((mod) => { DataflashParser = mod.default });
          addToOutput("Parser package installed successfully.");
        } catch (error) {
          addToOutput(`Failed to install parser: ${error}`);
        }

        // Define a custom Python function to capture print statements
        await pyodide.runPython(`
          import sys
          from js import document

          class JsOutput:
              def __init__(self):
                  self.output_element = document.getElementById("output")

              def write(self, message):
                  self.output_element.value += message

              def flush(self):
                  pass

          sys.stdout = JsOutput()
          sys.stderr = JsOutput()
        `);
        
        document.getElementById('parseButton').addEventListener('click', async () => {
          const fileInput = document.getElementById('fileInput');
          const tfCheckbox = document.getElementById('tf_checkbox').checked;
          const ssCheckbox = document.getElementById('ss_checkbox').checked;
          if(tfCheckbox)
          {
          const inputname = document.getElementById('input_name').value.trim();
          const inputField = document.getElementById('input_field').value.trim();
          const outputname = document.getElementById('output_name').value.trim();
          const outputField = document.getElementById('output_field').value.trim();
          const Numerator = document.getElementById('customNumerator').value.trim();
          const Denominator = document.getElementById('customDenominator').value.trim();
          const symbolic_var = document.getElementById('tf_params').value.trim();
          const t_start = document.getElementById('starttime').value.trim();
          const t_end = document.getElementById('endtime').value.trim();
          const output = document.getElementById('output');

          if (fileInput.files.length === 0) {
            alert('Please select a log file');
            return;
          }

          if (!inputField || !outputField) {
            alert('Please enter input and output fields');
            return;
          }

          const file = fileInput.files[0];
          const reader = new FileReader();
          reader.onload = async function (event) {
          const logData = event.target.result;

          const parser = new DataflashParser();
          parser.processData(logData);
          const timeData = parser.get(inputname,"TimeUS");            
          const fieldData1 = parser.get(inputname,inputField);
          const fieldData2 = parser.get(outputname,outputField);
          const Mode = parser.get("MODE","Mode")

          await pyodide.globals.set("input_data", fieldData1);
          await pyodide.globals.set("output_data", fieldData2);
          await pyodide.globals.set("time_data", timeData);
          await pyodide.globals.set("input_field",inputField);
          await pyodide.globals.set("output_field",outputField);
          await pyodide.globals.set("numerator", Numerator);
          await pyodide.globals.set("denominator", Denominator);
          await pyodide.globals.set("symbols",symbolic_var);
          await pyodide.globals.set("t_start",t_start);
          await pyodide.globals.set("t_end",t_end)
          
          await pyodide.runPython(`
            import numpy as np
            from AircraftIden import FreqIdenSIMO, TransferFunctionFit
            import math
            import sympy as sp
            from AircraftIden import FreqIdenSIMO, TransferFunctionFit, TransferFunctionParamModel
            from AircraftIden.TransferFunctionFit import plot_fitter
            import matplotlib
            plt = matplotlib.pyplot
            t_start = float(t_start)/1000000
            t_end = float(t_end)/1000000
            matplotlib.use("module://matplotlib_pyodide.html5_canvas_backend")
            time_seq_source = np.array(time_data).flatten()/1000000
            ind1 = 0
            ind2 = time_seq_source.size
            for i in range(time_seq_source.size):
              if time_seq_source[i] == t_start or (time_seq_source[i] < t_start and time_seq_source[i+1] > t_start):
                ind1 = i
              
              if time_seq_source[i] == t_end or (time_seq_source[i] < t_end and time_seq_source[i+1] > t_end):
                ind2 = i
                break
            print("start index: ",ind1," end index: ",ind2)
            time_seq_source = time_seq_source[ind1:ind2]
            print("no error in time_seq: ", time_seq_source.size)
            yout_source = np.array(input_data).flatten()
            print("youy size before splicing: ", yout_source.size, yout_source.shape)
            yout_source = yout_source[ind1:ind2]
            print("no error in yout: ", yout_source.size)
            gz_source = np.array(output_data).flatten()
            gz_source = gz_source*math.pi / 180
            gz_source = gz_source[ind1:ind2]
            print("no error in gz_source: ", gz_source.size)
            simo_iden = FreqIdenSIMO(time_seq_source,1, 15, yout_source, gz_source, win_num=None)

            plt.rc("figure", figsize=(15,10))
            plt.figure("pout->udot")
            simo_iden.plt_bode_plot(0)

            s = sp.symbols("s")
            tau = sp.symbols("tau")
            
            freq, H, gamma2, gxx, gxy, gyy = simo_iden.get_freq_iden(0)

            tf_params = sp.symbols(str(symbols))
            num = sp.simplify(str(numerator))
            den = sp.simplify(str(denominator))
            tfpm = TransferFunctionParamModel(num, den, tau)
            fitter = TransferFunctionFit(freq, H, gamma2, tfpm, nw=20, iter_times=1, reg = 0.1)
            tf = fitter.estimate(2, 20, accept_J=50)
            num, den, tau = fitter.get_coefficients()
            print("numerator: ",num)
            print("denominator: ",den)
            plot_fitter(fitter,str(input_field)+"->"+str(output_field))
            plt.show()

          `);
        };
          reader.readAsArrayBuffer(file); 
          }
        else if(ssCheckbox)
        {
          alert("State Space checkbox selected");
          if (fileInput.files.length === 0) {
            alert('Please select a log file');
            return;
          }

          if (!inputField || !outputField) {
            alert('Please enter input and output fields');
            return;
          }

          const file = fileInput.files[0];
          const reader = new FileReader();
          reader.onload = async function (event) {
          const logData = event.target.result;

          const parser = new DataflashParser();
          parser.processData(logData);

          const num_Inputs = document.getElementById('num_Inputs').value.trim();
          const num_Outputs = document.getElementById('num_Outputs').value.trim();

          await pyodide.runPython(`
            print("testing")
          `)
          }
        }
        });
      }

      main().catch((error) => {
        console.error(error);
        const output = document.getElementById("output");
        output.value += '\nError during execution:\n' + error;
      });

      function addToOutput(message) {
        const output = document.getElementById("output");
        output.value += message + "\n";
      }
    </script>
  </body>
</html>
