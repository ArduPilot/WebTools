<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>ArduPilot Filter Review Tool</title>
<script src='https://cdn.plot.ly/plotly-2.20.0.min.js'></script>
<script src="https://unpkg.com/mathjs/lib/browser/math.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"> </script>
<script type="text/javascript" src="../JsDataflashParser/parser.js"></script>
<script type="text/javascript" src="DecodeDevID.js"></script>

</head>
<a href="https://ardupilot.org"><img src="../images/ArduPilot.png"></a>
<h1>ArduPilot Filter Review Tool</h1>

<body>

<style>
    div.plotly-notifier {
        visibility: hidden;
    }

    label.parameter_input_label {
        display: inline-block;
        width: 160px;
        margin:5px 0px;
    }
</style>

<table>
<tr>
<td style="width: 30px;"></td>
<td>
<fieldset style="width:1100px">
    <legend>Setup</legend>
    <table>
        <tr>
            <td>
                <fieldset style="width:150px;height:80px">
                    <legend>Amplitude scale</legend>
                    <input type="radio" id="ScaleLog" name="Scale" checked>
                    <label for="LogScale">dB</label><br>
                    <input type="radio" id="ScaleLinear" name="Scale">
                    <label for="LinearScale">Linear</label><br>
                </fieldset>
            </td>
            <td>
                <fieldset style="width:200px;height:80px">
                    <legend>Spectrum scale</legend>
                    <input type="radio" id="SpectrumLinear" name="SpectrumScale" checked>
                    <label for="SpectrumLinear">Linear</label><br>
                    <input type="radio" id="SpectrumPSD" name="SpectrumScale">
                    <label for="SpectrumPSD">Power Spectral Density</label><br>
                </fieldset>
            </td>
            <td>
                <fieldset style="width:150px;height:80px">
                    <legend>Frequency scale</legend>
                    <table>
                        <tr>
                            <td>
                                <input type="radio" id="freq_ScaleLinear" name="feq_scale" checked>
                                <label for="LinearScale">Linear</label><br>
                                <input type="radio" id="freq_ScaleLog" name="feq_scale">
                                <label for="LogScale">Log</label><br>
                            </td>
                            <td>
                                <input type="radio" id="freq_Scale_Hz" name="feq_unit" checked>
                                <label for="Scale_unit_Hz">Hz</label><br>
                                <input type="radio" id="freq_Scale_RPM" name="feq_unit">
                                <label for="Scale_unit_RPM">RPM</label><br>
                            </td>
                        </tr>
                    </table>
                </fieldset>
            </td>
            <td>
                <fieldset style="width:100px;height:80px">
                    <legend>Log type</legend>
                    <input type="radio" id="log_type_batch" name="log_type" checked>
                    <label for="log_type_batch">Batch</label><br>
                    <input type="radio" id="log_type_raw" name="log_type">
                    <label for="log_type_raw">Raw sensor</label><br>
                </fieldset>
            </td>
            <td>
                <fieldset style="width:200px;height:80px">
                    <legend>FFT Settings</legend>
                    <table>
                        <tr>
                            <td style="width: 125px;">
                                <label for="FFTWindow_per_batch">Windows per batch</label><br><br>
                                <label for="FFTWindow_size">Windows size</label>
                            </td>
                            <td>
                                <input id="FFTWindow_per_batch" name="FFTWindow_per_batch" type="number" min="1" step="1" value="1" onchange="clear_calculation()" style="width:50px"/><br><br>
                                <input id="FFTWindow_size" name="FFTWindow_size" type="number" min="1" step="1" value="1024" onchange="clear_calculation()" style="width:50px"/>
                            </td>
                        </tr>
                    </table>
                </fieldset>
            </td>
            <td>
                <fieldset style="width:200px;height:80px">
                    <legend>Analysis time</legend>
                    <label for="TimeStart">Start</label>
                    <input id="TimeStart" name="TimeStart" type="number" min="0" step="1" value="0" onchange="" style="width:50px" disabled/>
                    s<br><br>
                    <label for="TimeEnd">End</label>
                    <input id="TimeEnd" name="TimeEnd" type="number" min="0" step="1" value="0" onchange="" style="width:50px" disabled/>
                    s
                </fieldset>
            </td>
        </tr>
    </table>
    <p>
        Bin log:
        <input id="fileItem" type="file" accept=".bin" onchange="readFile(this)">
        <input type="button" id="calculate" value="Calculate" onclick="re_calc()" disabled>
    </p>
</fieldset>
</td>
</tr>
</table>
<p>
    <div id="FFTPlot" style="width:1200px;height:450px"></div>
</p>
<table>
    <tr>
        <td style="width: 60px;"></td>
        <td>
            <fieldset style="width:300px">
                <legend>Gyro 1</legend>
                <label id="Gyro0_info"><br></label>
                <p>
                    <fieldset style="width:300px">
                        <legend>Pre-filter</legend>
                        <input type="checkbox" id="Gyro0PreX" name="Gyro0PreX" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro0PreX">X</label>

                        <input type="checkbox" id="Gyro0PreY" name="Gyro0PreY" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro0PreY">Y</label>

                        <input type="checkbox" id="Gyro0PreZ" name="Gyro0PreZ" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro0PreZ">Z</label>
                    </fieldset>
                </p>
                <p>
                    <fieldset style="width:300px">
                        <legend>Post-filter</legend>
                        <input type="checkbox" id="Gyro0PostX" name="Gyro0PostX" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro0PostX">X</label>

                        <input type="checkbox" id="Gyro0PostY" name="Gyro0PostY" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro0PostY">Y</label>

                        <input type="checkbox" id="Gyro0PostZ" name="Gyro0PostZ" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro0PostZ">Z</label>
                    </fieldset>
                </p>
                <p>
                    <fieldset style="width:300px">
                        <legend>Estimated post-filter</legend>
                        <input type="checkbox" id="Gyro0PostEstX" name="Gyro0PostEstX" onchange="update_hidden(this)" disabled>
                        <label for="Gyro0PostEstX">X</label>

                        <input type="checkbox" id="Gyro0PostEstY" name="Gyro0PostEstY" onchange="update_hidden(this)" disabled>
                        <label for="Gyro0PostEstY">Y</label>

                        <input type="checkbox" id="Gyro0PostEstZ" name="Gyro0PostEstZ" onchange="update_hidden(this)" disabled>
                        <label for="Gyro0PostEstZ">Z</label>
                    </fieldset>
                </p>
                <label id="Gyro0_FFT_info"><br><br><br></label>
             </fieldset>
        </td>
        <td>
            <fieldset style="width:300px">
                <legend>Gyro 2</legend>
                <label id="Gyro1_info"><br></label>
                <p>
                    <fieldset style="width:300px">
                        <legend>Pre-filter</legend>
                        <input type="checkbox" id="Gyro1PreX" name="Gyro1PreX" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro1PreX">X</label>

                        <input type="checkbox" id="Gyro1PreY" name="Gyro1PreY" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro1PreY">Y</label>

                        <input type="checkbox" id="Gyro1PreZ" name="Gyro1PreZ" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro1PreZ">Z</label>
                    </fieldset>
                    </p>
                    <p>
                    <fieldset style="width:300px">
                        <legend>Post-filter</legend>
                        <input type="checkbox" id="Gyro1PostX" name="Gyro1PostX" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro1PostX">X</label>

                        <input type="checkbox" id="Gyro1PostY" name="Gyro1PostY" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro1PostY">Y</label>

                        <input type="checkbox" id="Gyro1PostZ" name="Gyro1PostZ" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro1PostZ">Z</label>
                    </fieldset>
                </p>
                <p>
                    <fieldset style="width:300px">
                        <legend>Estimated post-filter</legend>
                        <input type="checkbox" id="Gyro1PostEstX" name="Gyro1PostEstX" onchange="update_hidden(this)" disabled>
                        <label for="Gyro1PostEstX">X</label>

                        <input type="checkbox" id="Gyro1PostEstY" name="Gyro1PostEstY" onchange="update_hidden(this)" disabled>
                        <label for="Gyro1PostEstY">Y</label>

                        <input type="checkbox" id="Gyro1PostEstZ" name="Gyro1PostEstZ" onchange="update_hidden(this)" disabled>
                        <label for="Gyro1PostEstZ">Z</label>
                    </fieldset>
                </p>
                <label id="Gyro1_FFT_info"><br><br><br></label>
            </fieldset>
        </td>
        <td>
            <fieldset style="width:300px">
                <legend>Gyro 3</legend>
                <label id="Gyro2_info"><br></label>
                <p>
                    <fieldset style="width:300px">
                        <legend>Pre-filter</legend>
                        <input type="checkbox" id="Gyro2PreX" name="Gyro2PreX" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro2PreX">X</label>

                        <input type="checkbox" id="Gyro2PreY" name="Gyro2PreY" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro2PreY">Y</label>

                        <input type="checkbox" id="Gyro2PreZ" name="Gyro2PreZ" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro2PreZ">Z</label>
                    </fieldset>
                </p>
                <p>
                    <fieldset style="width:300px">
                        <legend>Post-filter</legend>
                        <input type="checkbox" id="Gyro2PostX" name="Gyro2PostX" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro2PostX">X</label>
    
                        <input type="checkbox" id="Gyro2PostY" name="Gyro2PostY" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro2PostY">Y</label>
    
                        <input type="checkbox" id="Gyro2PostZ" name="Gyro2PostZ" onchange="update_hidden(this)" checked disabled>
                        <label for="Gyro2PostZ">Z</label>
                    </fieldset>
                </p>
                <p>
                    <fieldset style="width:300px">
                        <legend>Estimated post-filter</legend>
                        <input type="checkbox" id="Gyro2PostEstX" name="Gyro2PostEstX" onchange="update_hidden(this)" disabled>
                        <label for="Gyro2PostEstX">X</label>
    
                        <input type="checkbox" id="Gyro2PostEstY" name="Gyro2PostEstY" onchange="update_hidden(this)" disabled>
                        <label for="Gyro2PostEstY">Y</label>
    
                        <input type="checkbox" id="Gyro2PostEstZ" name="Gyro2PostEstZ" onchange="update_hidden(this)" disabled>
                        <label for="Gyro2PostEstZ">Z</label>
                    </fieldset>
                </p>
                <label id="Gyro2_FFT_info"><br><br><br></label>
            </fieldset>
        </td>
    </tr>
</table>

<table>
<tr>
<td style="width: 60px;"></td>
<td>
<fieldset style="width:1070px">
    <legend>Gyro filter</legend>
    <p>
        <label class="parameter_input_label" for="INS_GYRO_FILTER">INS_GYRO_FILTER</label>
        <input id="INS_GYRO_FILTER" name="INS_GYRO_FILTER" type="number" step="0.1" value="20.0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px"/>
    </p>
</fieldset>
<fieldset style="width:1070px">
    <legend>First Notch Filter</legend>
    <p>
        <label class="parameter_input_label" for="INS_HNTCH_ENABLE">INS_HNTCH_ENABLE</label>
        <input id="INS_HNTCH_ENABLE" name="INS_HNTCH_ENABLE" type="number" step="1" value="0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px"/>
        <label id="INS_HNTCH_ENABLE.doc"></label>
    </p>
    <p>
        <label class="parameter_input_label" for="INS_HNTCH_MODE">INS_HNTCH_MODE</label>
        <input id="INS_HNTCH_MODE" name="INS_HNTCH_MODE" type="number" step="1" value="0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px" disabled/>
        <label id="INS_HNTCH_MODE.doc"></label>
    </p>
    <p>
        <label class="parameter_input_label" for="INS_HNTCH_FREQ">INS_HNTCH_FREQ</label>
        <input id="INS_HNTCH_FREQ" name="INS_HNTCH_FREQ" type="number" step="0.1" value="0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px" disabled/>
    </p>
    <p>
        <label class="parameter_input_label" for="INS_HNTCH_BW">INS_HNTCH_BW</label>
        <input id="INS_HNTCH_BW" name="INS_HNTCH_BW" type="number" step="0.1" value="0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px" disabled/>
    </p>
    <p>
        <label class="parameter_input_label" for="INS_HNTCH_ATT">INS_HNTCH_ATT</label>
        <input id="INS_HNTCH_ATT" name="INS_HNTCH_ATT" type="number" step="0.1" value="0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px" disabled/>
    </p>
    <p>
        <label class="parameter_input_label" for="INS_HNTCH_REF">INS_HNTCH_REF</label>
        <input id="INS_HNTCH_REF" name="INS_HNTCH_REF" type="number" step="0.01" value="0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px" disabled/>
    </p>
    <p>
        <label class="parameter_input_label" for="INS_HNTCH_FM_RAT">INS_HNTCH_FM_RAT</label>
        <input id="INS_HNTCH_FM_RAT" name="INS_HNTCH_FM_RAT" type="number" step="0.01" value="1.0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px" disabled/>
    </p>
    <p>
        <label class="parameter_input_label" for="INS_HNTCH_HMNCS">INS_HNTCH_HMNCS</label>
        <input id="INS_HNTCH_HMNCS" name="INS_HNTCH_HMNCS" type="number" step="1" value="1" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px" disabled/>
        <label id="INS_HNTCH_HMNCS.doc"></label>
    </p>
    <p>
        <label class="parameter_input_label" for="INS_HNTCH_OPTS">INS_HNTCH_OPTS</label>
        <input id="INS_HNTCH_OPTS" name="INS_HNTCH_OPTS" type="number" step="1" value="0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px" disabled/>
        <label id="INS_HNTCH_OPTS.doc"></label>
    </p>
</fieldset>
<fieldset style="width:1070px">
    <legend>Second Notch Filter</legend>
    <p>
        <label class="parameter_input_label" for="INS_HNTC2_ENABLE">INS_HNTC2_ENABLE</label>
        <input id="INS_HNTC2_ENABLE" name="INS_HNTC2_ENABLE" type="number" step="1" value="0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px"/>
        <label id="INS_HNTC2_ENABLE.doc"></label>
    </p>
    <p>
        <label class="parameter_input_label" for="INS_HNTC2_MODE">INS_HNTC2_MODE</label>
        <input id="INS_HNTC2_MODE" name="INS_HNTC2_MODE" type="number" step="1" value="0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px" disabled/>
        <label id="INS_HNTC2_MODE.doc"></label>
    </p>
    <p>
        <label class="parameter_input_label" for="INS_HNTC2_FREQ">INS_HNTC2_FREQ</label>
        <input id="INS_HNTC2_FREQ" name="INS_HNTC2_FREQ" type="number" step="0.1" value="0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px" disabled/>
    </p>
    <p>
        <label class="parameter_input_label" for="INS_HNTC2_BW">INS_HNTC2_BW</label>
        <input id="INS_HNTC2_BW" name="INS_HNTC2_BW" type="number" step="0.1" value="0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px" disabled/>
    </p>
    <p>
        <label class="parameter_input_label" for="INS_HNTC2_ATT">INS_HNTC2_ATT</label>
        <input id="INS_HNTC2_ATT" name="INS_HNTC2_ATT" type="number" step="0.1" value="0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px" disabled/>
    </p>
    <p>
        <label class="parameter_input_label" for="INS_HNTC2_REF">INS_HNTC2_REF</label>
        <input id="INS_HNTC2_REF" name="INS_HNTC2_REF" type="number" step="0.01" value="0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px" disabled/>
    </p>
    <p>
        <label class="parameter_input_label" for="INS_HNTC2_FM_RAT">INS_HNTC2_FM_RAT</label>
        <input id="INS_HNTC2_FM_RAT" name="INS_HNTC2_FM_RAT" type="number" step="0.01" value="1.0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px" disabled/>
    </p>
    <p>
        <label class="parameter_input_label" for="INS_HNTC2_HMNCS">INS_HNTC2_HMNCS</label>
        <input id="INS_HNTC2_HMNCS" name="INS_HNTC2_HMNCS" type="number" step="1" value="1" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px" disabled/>
        <label id="INS_HNTC2_HMNCS.doc"></label>
    </p>
    <p>
        <label class="parameter_input_label" for="INS_HNTC2_OPTS">INS_HNTC2_OPTS</label>
        <input id="INS_HNTC2_OPTS" name="INS_HNTC2_OPTS" type="number" step="1" value="0" onchange="filter_param_read(); redraw_Spectrogram();" style="width: 100px" disabled/>
        <label id="INS_HNTC2_OPTS.doc"></label>
    </p>
</fieldset>
</td>
</tr>
</table>

<p>
    <div id="Spectrogram" style="width:1200px;height:450px"></div>
</p>

<table>
    <tr>
        <td style="width: 60px;"></td>
        <td>
            <fieldset style="width:300px;height:350px">
                <legend>Spectrogram Options</legend>
                <p>
                    <fieldset style="width:300px">
                        <legend>Gyro instance</legend>
                        <input type="radio" id="SpecGyroInst0" name="SpecGyroInst" onchange="redraw_Spectrogram()" disabled>
                        <label for="SpecGyroInst0">1</label>

                        <input type="radio" id="SpecGyroInst1" name="SpecGyroInst" onchange="redraw_Spectrogram()" disabled>
                        <label for="SpecGyroInst1">2</label>

                        <input type="radio" id="SpecGyroInst2" name="SpecGyroInst" onchange="redraw_Spectrogram()" disabled>
                        <label for="SpecGyroInst2">3</label>
                    </fieldset>
                </p>
                <p>
                    <fieldset style="width:300px">
                        <legend>Filtering</legend>
                        <input type="radio" id="SpecGyroPre" name="SpecGyroPrePost" onchange="redraw_Spectrogram()" disabled>
                        <label for="SpecGyroPre">Pre-filter</label>

                        <input type="radio" id="SpecGyroPost" name="SpecGyroPrePost" onchange="redraw_Spectrogram()" disabled>
                        <label for="SpecGyroPost">Post-filter</label>
                    </fieldset>
                </p>
                <p>
                    <fieldset style="width:300px">
                        <legend>Axis</legend>
                        <input type="radio" id="SpecGyroAxisX" name="SpecGyroAxis" onchange="redraw_Spectrogram()" disabled>
                        <label for="SpecGyroAxisX">X</label>

                        <input type="radio" id="SpecGyroAxisY" name="SpecGyroAxis" onchange="redraw_Spectrogram()" disabled>
                        <label for="SpecGyroAxisY">Y</label>

                        <input type="radio" id="SpecGyroAxisZ" name="SpecGyroAxis" onchange="redraw_Spectrogram()" disabled>
                        <label for="SpecGyroAxisZ">Z</label>
                    </fieldset>
                </p>
            </fieldset>
        </td>
    </tr>
</table>




</body>

<script type="text/javascript" src="FilterReview.js"></script>
<script>
    function readFile(e) {
        const file = e.files[0]
        if (file == null) {
            return
        }
        let reader = new FileReader()
        reader.onload = function (e) {
            load(reader.result)
        }
        reader.readAsArrayBuffer(file)
    }

</script>
